<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chatterbox Voice Clone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <main class="wrap">
      <h1>Chatterbox Voice Clone (local)</h1>
      This is a voice cloning tool. It's 100% run locally on your system.
      You provide a short audio clip in .wav format as a reference to clone.
      Then either select one of the default texts or write your own. When you generate
      the output, you can play or download the audio below. Note that noisy input/reference
      audio will lead to a worse output. Longer texts will use more system resources, so it's
      probably best to stick to 1-5 sentences.
      <form id="form">
        <label>
          Reference voice WAV
          <input id="voice_wav" name="voice_wav" type="file" accept=".wav,audio/wav" required />
        </label>

        <label>
          Text to synthesize
          <textarea id="text" name="text" rows="4" required></textarea>
        </label>

        <button id="params-toggle" class="params-toggle" type="button">Advanced Parameters ▼</button>

        <div id="params-section" class="params-section">
          <div class="param-control">
            <label>
              Temperature (Default: 0.8)
              <div class="param-description">Lower = more consistent/focused, Higher = more varied/creative</div>
            </label>
            <div class="param-input-group">
              <input type="range" name="temperature" id="temperature" class="param-slider" min="0.5" max="1.2" step="0.1" value="0.8" />
              <span class="param-value" data-target="temperature">0.8</span>
            </div>
          </div>

          <div class="param-control">
            <label>
              Top P - Nucleus Sampling (Default: 0.95)
              <div class="param-description">Lower = more focused/predictable, Higher = more diverse choices</div>
            </label>
            <div class="param-input-group">
              <input type="range" name="top_p" id="top_p" class="param-slider" min="0.85" max="0.98" step="0.01" value="0.95" />
              <span class="param-value" data-target="top_p">0.95</span>
            </div>
          </div>

          <div class="param-control">
            <label>
              Top K (Default: 1000)
              <div class="param-description">Lower = more focused vocabulary, Higher = more varied word choices</div>
            </label>
            <div class="param-input-group">
              <input type="range" name="top_k" id="top_k" class="param-slider" min="100" max="1000" step="50" value="1000" />
              <span class="param-value" data-target="top_k">1000</span>
            </div>
          </div>

          <div class="param-control">
            <label>
              Repetition Penalty (Default: 1.2)
              <div class="param-description">1.0 = no penalty (may repeat), Higher = less repetition</div>
            </label>
            <div class="param-input-group">
              <input type="range" name="repetition_penalty" id="repetition_penalty" class="param-slider" min="1.0" max="1.5" step="0.1" value="1.2" />
              <span class="param-value" data-target="repetition_penalty">1.2</span>
            </div>
          </div>
        </div>

        <button id="btn" type="submit">Generate</button>
      </form>

      <section id="status" class="status hidden">
        <div class="row">
          <div id="state">Queued…</div>
          <div id="pct">0%</div>
        </div>
        <div class="bar">
          <div id="barFill" class="barFill"></div>
        </div>
      </section>

      <section id="result" class="result hidden">
        <h2>Result</h2>
        <audio id="player" controls></audio>
        <div class="actions">
          <a id="download" download>Download WAV</a>
        </div>
      </section>

      <section id="error" class="error hidden"></section>
    </main>

    <script>
      const APHORISMS = [
        "Playing it safe can cause a lot of damage in the long run.",
        "Hard work pays off over time, [laugh] but laziness pays off NOW.",
        "Misfortune is a kind of fortune that never misses.",
        "Mirrors would do well to reflect a little more before sending back images.",
        "Those who were carried to a goal should not think they've reached it."
      ];

      // Parameter persistence and UI handling
      const PARAM_KEYS = ['temperature', 'top_p', 'top_k', 'repetition_penalty'];
      const LOCAL_STORAGE_KEY = 'chatterbox_params';

      function saveParameters() {
        const params = {};
        PARAM_KEYS.forEach(key => {
          const elem = document.getElementById(key);
          params[key] = elem ? elem.value : undefined;
        });
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(params));
      }

      function loadParameters() {
        const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (saved) {
          try {
            const params = JSON.parse(saved);
            PARAM_KEYS.forEach(key => {
              const elem = document.getElementById(key);
              if (elem && params[key]) {
                elem.value = params[key];
                updateParamValue(key);
              }
            });
          } catch (e) {
            console.error('Failed to load parameters:', e);
          }
        }
      }

      function updateParamValue(paramId) {
        const elem = document.getElementById(paramId);
        const valueDisplay = document.querySelector(`.param-value[data-target="${paramId}"]`);
        if (elem && valueDisplay) {
          const value = parseFloat(elem.value);
          valueDisplay.textContent = paramId === 'top_k' ? Math.round(value) : value.toFixed(paramId === 'top_p' ? 2 : 1);
        }
      }

      // Load random aphorism and parameters on page load
      document.addEventListener('DOMContentLoaded', () => {
        const randomIndex = Math.floor(Math.random() * APHORISMS.length);
        document.getElementById('text').value = APHORISMS[randomIndex];

        // Load saved parameters
        loadParameters();

        // Setup parameter toggle
        const toggle = document.getElementById('params-toggle');
        const section = document.getElementById('params-section');
        if (toggle && section) {
          toggle.addEventListener('click', (e) => {
            e.preventDefault();
            section.classList.toggle('visible');
            toggle.classList.toggle('active');
            toggle.textContent = section.classList.contains('visible') ? 'Advanced Parameters ▲' : 'Advanced Parameters ▼';
          });
        }

        // Setup slider value updates
        PARAM_KEYS.forEach(key => {
          const elem = document.getElementById(key);
          if (elem) {
            elem.addEventListener('input', () => {
              updateParamValue(key);
              saveParameters();
            });
          }
        });
      });
    </script>

    <script src="/static/app.js"></script>
  </body>
</html>
